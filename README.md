# learn ç”¨å¤„
å…³äº`lerna`ï¼Œåªæ˜¯ä½¿ç”¨`lerna` å‘å¸ƒé¡¹ç›®ã€åˆ›å»ºåŒ…çš„å‘½ä»¤

# monorepo

å…³äº `monorepo` æœ‰ä¸‰ä¸ªè§£å†³æ–¹æ¡ˆ
* `npm link` or `file`
* `yarn workspace`
* `npm workspace`

ç¬¬ä¸€ä¸ªæ–¹æ¡ˆï¼Œä¼šå¯¼è‡´é¡¹ç›®æ•´ä½“ä¼šç‰¹åˆ«å¤§ï¼Œæ¯ä¸€ä¸ªé¡¹ç›®çš„`package.json`éƒ½ä¼šä¸‹è½½ä¸€é

ä¸åŒé¡¹ç›®ä¹‹é—´çš„å¼•ç”¨ é€šè¿‡ `npm link` å’Œ `file` çš„æ–¹å¼ï¼Œè¿™ç§æ–¹å¼åªèƒ½æ‰‹åŠ¨æ“ä½œ

ç¬¬äºŒä¸ªæ–¹æ¡ˆ

åœ¨å®è·µè¿‡ç¨‹ä¸­ `yarn` å¯¹äº `package.json` ä¸­çš„ `name`å±æ€§çš„å€¼è¦æ±‚ç‰¹åˆ«ä¸¥æ ¼ï¼Œ å¯¹äºåæœŸæ¨¡ç‰ˆé¡¹ç›®ï¼Œ`name`é€šè¿‡ `ejs`åŠ¨æ€åŠ è½½ï¼Œå¤„ç†æ¯”è¾ƒéº»çƒ¦

[ç¬¬ä¸€ç‰ˆ](https://github.com/TaroSunn/sickle-cli/tree/main)ä½¿ç”¨`yarn workspace` æ–¹æ¡ˆ

~~æ‰€ä»¥æ­¤æ¬¡é‡æ„ ä½¿ç”¨ npm workspaceï¼Œè¸©ä¸€ä¸‹ npm workspace çš„å‘~~

ä½¿ç”¨è¿™ç§æ–¹å¼æ— æ³•åˆ é™¤`node_modules`ä¸­çš„ä¾èµ–åŒ…

æš‚æ—¶é‡‡ç”¨`yarn workspace`æ–¹æ¡ˆ ğŸ˜‚

# npm workspaceä½¿ç”¨
 
`npm workspace` çš„ä½¿ç”¨æ–¹å¼ä¸`yarn workspace`ç±»ä¼¼

æ ¹ç›®å½•ä¸‹ é…ç½® `workspace` ç›®å½•

```
"workspaces": [
    "./packages/*"
],
```

å®‰è£… package

ä¾‹å¦‚åœ¨ `@sickle/cli` ä¸‹å®‰è£… `axios`ï¼Œåˆ™éœ€è¦æ‰§è¡Œå‘½ä»¤`npm i axios --workspace @sickle/cli`

# yarn workspaceä½¿ç”¨

é…ç½® `package.json`
``` json
{
  "private": true,
  "workspaces": ["workspace-a", "workspace-b"]
}
```

å®‰è£…ä¾èµ–

```
yarn workspace packageå (add or remove) ä¾èµ–å

yarn workspace @sickle/cli add axios
```

é»˜è®¤ æ‰§è¡Œ`add`æ—¶ä¼šå»npmä¸Šä¸‹è½½ï¼Œæ­¤æ—¶å®‰è£…çš„ä¸æ˜¯å½“å‰æœ¬åœ°çš„ç‰ˆæœ¬ï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡åŠ ç‰ˆæœ¬å·æ¥æ›´æ–°æœ¬åœ°ç‰ˆæœ¬

å®‰è£…å…¨éƒ¨ä¾èµ–
```
yarn install
```

# æ ¹ç›®å½•å®‰è£…pakcage
å¦‚æœæƒ³è¦åœ¨æ ¹ç›®å½•å®‰è£…åŒ…ï¼Œéœ€è¦ä½¿ç”¨ `-W`çš„æ–¹å¼

```
yarn add packageå -W
```


# lerna ä½¿ç”¨

å¸¸ç”¨å‘½ä»¤
* lerna create åŒ…å
* lerna version
* lerna publish

ä½¿ç”¨`lerna create`å‘½ä»¤æ—¶ï¼Œå¯ä»¥ä¼ å…¥åˆ›å»ºpackageç›®å½•åœ°å€ï¼Œé»˜è®¤ä¸å†™åœ°å€ï¼Œä¼š`lerna.json`ä¸­çš„`packages`ä¸­çš„ç¬¬ä¸€ä¸ªä½œä¸ºé»˜è®¤åœ°å€ 

# é¡¹ç›®ç›®å½•

é¡¹ç›®åˆ†ä¸ºå››ä¸ªä¸»ç›®å½•

* commands
* core
* models
* utils

## commands
å°†è„šæ‰‹æ¶æ‰€éœ€è¦çš„å‘½ä»¤é€»è¾‘æ”¾åˆ°commandsæ–‡ä»¶å¤¹ä¸‹
ç°åœ¨å­˜åœ¨çš„å‘½ä»¤æœ‰

`init`å‘½ä»¤

## core

è„šæ‰‹æ¶ä¸»è¦é€»è¾‘éƒ½æ”¾åˆ°äº†coreç›®å½•ä¸‹

* cli è„šæ‰‹æ¶å‘½ä»¤æ‰§è¡Œç›®å½•
* exec åŠ¨æ€åŠ è½½npmåŒ…

## models

æŠŠæœ‰äº›ç»Ÿä¸€çš„åŠŸèƒ½å°è£…æˆä¸€ä¸ªmodelsï¼Œä½¿ç”¨ç±»çš„æ–¹å¼ï¼Œæ¥æœç”¨è¿™äº›åŠŸèƒ½

### package

Package æä¾›ä¸€ä¸‹å‡ ä¸ªæ–¹æ³•

#### exists åˆ¤æ–­å½“å‰Packageæ˜¯å¦å­˜åœ¨

#### install å®‰è£…Package

å®‰è£…Pakcageçš„åŠŸèƒ½ä¸»è¦æ˜¯é€šè¿‡[npminstall](https://www.npmjs.com/package/npminstall)æ¥å®ç°


#### update æ›´æ–°Package

#### getRootFilePath è·å–Packageå…¥å£æ–‡ä»¶è·¯å¾„

* é¦–å…ˆè·å–package.jsonæ‰€åœ¨ç›®å½• è¿™é‡Œå¯ä»¥ä½¿ç”¨[pkg-dir](https://www.npmjs.com/package/pkg-dir)è¿™ä¸ªåŒ…æ¥æŸ¥æ‰¾
* è¯»å–package.json mainç›®å½•
* è¾“å‡ºç›®å½•

åœ¨ä½¿ç”¨Packageæ—¶éœ€è¦ä¼ å…¥

#### targetPath packageè·¯å¾„
è¿™ä¸ªæ˜¯æ‰§è¡Œ init é€»è¾‘ç›®å½•

#### storePath packageç¼“å­˜è·¯å¾„
å¦‚æœæ²¡æœ‰å®‰è£…è¿‡ init å‘½ä»¤ é‚£ä¹ˆéœ€è¦å°† init é€»è¾‘ ç¼“å­˜åˆ°æœ¬åœ°çš„ä¸€ä¸ªè·¯å¾„ä¸‹

#### packageName packageçš„name
ç”¨äºä¸‹è½½ package

#### packageVersion packageçš„ç‰ˆæœ¬å·
ç”¨äºä¸‹è½½ packageVersion

## utils
è„šæ‰‹æ¶å°è£…äº†ä¸€ä¸‹utilsæ–¹æ³•ï¼Œæ”¾åˆ°utilsç›®å½•ä¸‹

ç°åœ¨å°è£…çš„æ–¹æ³•æœ‰

* get-npm-info è·å–npmåŒ…ä¿¡æ¯ã€ç‰ˆæœ¬ç­‰
* log ç”¨äºæ‰“å°æ—¥å¿—


# è„šæ‰‹æ¶æ‰§è¡Œå‘½ä»¤è¿‡ç¨‹

## æœ€ä½Nodejsç‰ˆæœ¬

è„šæ‰‹æ¶æœ€ä½æ”¯æŒçš„nodeç‰ˆæœ¬ä¸º`v12.0.0`,å¦‚æœä½äºè¿™ä¸ªç‰ˆæœ¬ï¼Œå°†ä¼šæŠ¥é”™

è¿™é‡Œå¤„ç†åˆ¤æ–­ç‰ˆæœ¬é‡‡ç”¨[semver](https://www.npmjs.com/package/semver)

## æ£€æŸ¥rootè´¦å·

å¦‚æœç”¨æˆ·ä½¿ç”¨ root è´¦å·æ¥åˆ›å»ºé¡¹ç›®ï¼Œä¼šå¯¼è‡´é¡¹ç›®å¼€å‘é‡åˆ°é—®é¢˜ï¼Œé‚£ä¹ˆåœ¨ç”¨æˆ·ä½¿ç”¨rootè´¦æˆ·åˆ›å»ºé¡¹ç›®æ—¶ï¼Œè¦å¯¹rootè´¦å·è¿›è¡Œé™çº§ï¼Œä»¥æ»¡è¶³åˆ›å»ºçš„é¡¹ç›®å¯ä»¥è¢«ä¿®æ”¹

åœ¨macç¯å¢ƒä¸‹ï¼Œä½¿ç”¨`process.geteuid()`,æ™®é€šç”¨æˆ·çš„`uid`æ˜¯501ï¼Œrootç”¨æˆ·ä¸º0

å¯ä»¥ä½¿ç”¨[root-check](https://www.npmjs.com/package/root-check)

## è·å–ç”¨æˆ·ä¸»ç›®å½•

è·å–ç”¨æˆ·ä¸»ç›®å½•çš„ä¸»è¦åŸå› æ˜¯ï¼ŒåæœŸä¼šå¯¹é¡¹ç›®å’Œé¡¹ç›®æ¨¡ç‰ˆåšç¼“å­˜ï¼Œç¼“å­˜çš„åœ°å€ä¸ºç”¨æˆ·ä¸»ç›®å½•

å¯ä»¥ä½¿ç”¨Node.jsåŸç”Ÿæ–¹æ³•`os.homedir()`

## è·å–ç¯å¢ƒå˜é‡

ä¼šè®²ä¸€éƒ¨åˆ†ä¿¡æ¯å‚¨å­˜åˆ°ç¯å¢ƒå˜é‡ä¸­ï¼Œè¯»å–ç¯å¢ƒå˜é‡ï¼Œä½¿ç”¨[dotenv](https://www.npmjs.com/package/dotenv)æ¥è·å–

## ç‰ˆæœ¬æç¤º

åœ¨æ‰§è¡Œè„šæ‰‹æ¶ä¸šåŠ¡é€»è¾‘ä¹‹å‰ï¼Œéœ€è¦å¯¹è„šæ‰‹æ¶çš„ç‰ˆæœ¬è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœæœ‰æ–°ç‰ˆæœ¬å‘å¸ƒï¼Œé‚£ä¹ˆéœ€è¦æç¤ºç”¨æˆ·æ›´æ–°è„šæ‰‹æ¶ç‰ˆæœ¬

å…·ä½“æµç¨‹
* è·å–package
* é€šè¿‡npm api è·å–packageä¿¡æ¯
* å€ŸåŠ©semverï¼Œå°†packageçš„version ä¸npmæœ€æ–°ç‰ˆæœ¬æ¯”è¾ƒ
* æç¤ºæˆ–ç»§ç»­æ‰§è¡Œåç»­æµç¨‹

## æ³¨å†Œè„šæ‰‹æ¶(commander)

### è„šæ‰‹æ¶å‘½ä»¤

è„šæ‰‹æ¶å‘½ä»¤éƒ¨åˆ†ï¼Œä½¿ç”¨`commander`è¿™ä¸ªåŒ…æ¥å¼€å‘

é™¤äº†`commander`æä¾›çš„`-V`è¾“å‡ºç‰ˆæœ¬å·ã€`-h`è¾“å‡ºå¸®åŠ©ä¿¡æ¯å¤–ï¼Œæˆ‘ä»¬è‡ªå®šä¹‰äº†

* -d debugé€‰é¡¹ï¼Œç”¨äºdebugï¼Œè¿™é‡Œdebugä¸ä¼šæœ‰å®è´¨çš„æ“ä½œï¼Œåªæ˜¯ç”¨äºæ‰“å°ä¿¡æ¯ç”¨

å¯¹äºé…æœ‰é…å¤‡åˆ°çš„å‘½ä»¤ï¼Œæˆ‘ä»¬é‡‡ç”¨è¾“å‡ºå¸®åŠ©ä¿¡æ¯çš„æ–¹å¼åšä¸€ä¸ªæç¤º

#### å‘½ä»¤ init

`init`å‘½ä»¤ï¼Œä»£ç ç»Ÿä¸€åœ¨`commands/init`ç›®å½•ä¸‹

`init`å‘½ä»¤åé¢å¯ä»¥è·Ÿä¸€ä¸ªé¡¹ç›®åç§°ï¼Œä¾‹å¦‚ `init testProject`

`init`å‘½ä»¤ï¼Œæœ‰ä¸€ä¸ª`-f, --force`çš„é€‰é¡¹ï¼Œè¿™ä¸ªé€‰é¡¹ä¸»è¦ç”¨å¤„æ˜¯æ¸…ç©ºå½“å‰å‘½ä»¤æ‰§è¡Œç›®å½•æ–‡ä»¶ï¼Œå¯èƒ½å®‰è£…è„šæ‰‹æ¶ç›®å½•å­˜åœ¨å…¶ä»–æ–‡ä»¶ï¼Œæ­¤æ—¶ä½¿ç”¨`-f`ï¼Œå°†ä¼šå¼ºåˆ¶æ¸…æ¥šå½“å‰ç›®å½•

#### é€‰é¡¹ targetPath

`-tp, --targetPath`è¿™ä¸ªé€‰é¡¹ç”¨äºæ‰§è¡Œæœ¬åœ°ä»£ç çš„è·¯å¾„, ç”¨äºè°ƒè¯•
